<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Teams Transcription</title>
    <style>
        h4 {
            margin-bottom: 5px;
            margin-top: 10px;
        }
        .container {
            border: solid grey 1px;
            border-radius: 5px;
            width: 100%;
            overflow: auto;
            margin-bottom: 5px;
        }
        #logs.hideDebug > .DEBUG {
            display: none;
        }
    </style>
</head>

<body>
    <div>
        Status: <span id="status">disconnected</span>
        <button onclick="test()" style="display: none">test</button>
    </div>
    <div>
        <h4 style="display: inline-block">Logs</h4>
        <label>level</label>
        <select onchange="setLogLevel(this)">
            <option value="INFO" selected>info</option>
            <option value="DEBUG">debug</option>
        </select>
    </div>
    <div id="logs" class="container hideDebug" style="height: 200px"></div>
    <h4>Messages</h4>
    <div id="messages" class="container" style="height: 200px"></div>
    <h4>Interim results</h4>
    <div id="interim" class="container" style="height: 60px"></div>

    <script type="text/javascript">

        const logs = document.getElementById("logs");
        const messages = document.getElementById("messages");
        const interim = document.getElementById("interim");
        const status = document.getElementById("status");

        function setLogLevel(e) {
            const { value } = e;
            if (value === 'DEBUG') {
                logs.classList.remove('hideDebug');
            } else {
                logs.classList.add('hideDebug');
            }
        }

        function showStatus(x) {
            status.innerHTML = x;
        }

        function showMessage(k, v) {
            const now = new Date().toLocaleString();
            if (k === "RECOGNIZING") {
                interim.innerHTML = `${now}: ${v}`;
            } else if (k === "RECOGNIZED") {
                const e = document.createElement("div");
                e.className = k;
                e.innerHTML = `${now}: ${v}`;
                messages.appendChild(e);
            } else {
                const e = document.createElement("div");
                e.className = k;
                e.innerHTML = `${now}: [${k}] ${v}`;;
                logs.appendChild(e);
            }
        };

        function createWebSocket() {
            const ws = new WebSocket("ws://teams.featherinthecap.com:8080");
            ws.onopen = () => showStatus("connected");
            ws.onclose = () => showStatus("disconnected");
            ws.onmessage = function (evt) {
                console.log({ evt });
                const { data } = evt;
                if (data === 'welcome') return;
                try {
                    const message = JSON.parse(data);
                    Object.entries(message).forEach(([k, v]) => showMessage(k, v));
                } catch (e) {
                    console.error(e);
                }
            };
        }

        async function test() {
            const wait = 200;
            post({ "INFO": "new session started" });
            await sleep(wait);
            post({ "DEBUG": "received audio" });
            await sleep(wait);
            post({ "RECOGNIZING": "hello" });
            await sleep(wait);
            post({ "RECOGNIZING": "hello world" });
            await sleep(wait);
            post({ "RECOGNIZING": "hello world!" });
            await sleep(wait);
            post({ "RECOGNIZED": "hello world!" });
            await sleep(wait);
            post({ "RECOGNIZING": "good" });
            await sleep(wait);
            post({ "RECOGNIZING": "goodbye" });
            await sleep(wait);
            post({ "RECOGNIZED": "goodbye" });
        }

        function post(data) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/publish", true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify(data));
        }

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        createWebSocket();
    </script>

</body>
</html>